# Ruler: .gitignore Update Functionality

## 1. Detailed Description of Change and Required Functionality

This new functionality will enhance the `ruler apply` command to automatically update the project's `.gitignore` file. The goal is to add all file paths generated by Ruler for various AI agents to `.gitignore`, ensuring these generated configuration files are not accidentally committed to the version control system.

### Core Requirements:

1.  **Automatic `.gitignore` Update**:
    * When `ruler apply` is executed, it should identify all file paths where it writes or modifies agent-specific configuration files.
    * These paths should be added to the `.gitignore` file located at the project root.

2.  **Idempotency and Formatting**:
    * The update process must be idempotent. If a file path is already present in `.gitignore` (either inside or outside a Ruler-managed block), it should not be added again to the Ruler-managed block.
    * Entries managed by Ruler should be grouped within a clearly marked block (e.g., using `# START Ruler Generated Files` and `# END Ruler Generated Files` markers).
    * Paths within this block should be sorted alphabetically.
    * The block should be added if it doesn't exist. If it does, its content should be updated (new paths added, existing ones maintained, all sorted).
    * Ensure backup files (e.g., `*.bak`) created by Ruler are *not* added to the `.gitignore` by this feature.

3.  **Configuration and Control**:
    * **Default Behaviour**: The `.gitignore` update functionality should be **enabled by default**.
    * **CLI Control**:
        * A new command-line option `--gitignore` will explicitly enable the feature. This reaffirms the default.
        * A new command-line option `--no-gitignore` will disable the feature for the current execution. This option has the highest precedence.
    * **TOML Configuration**:
        * A new section in `ruler.toml`, `[gitignore]`, will allow users to configure this behaviour.
        * The setting `enabled = true | false` within this section will control the feature.
        * The configuration precedence will be strictly:
            1.  CLI option (`--no-gitignore` or `--gitignore`).
            2.  `ruler.toml` setting (`[gitignore].enabled`).
            3.  Default behaviour (enabled).

4.  **File Path Handling**:
    * Paths added to `.gitignore` must be relative to the project root (the directory containing the `.gitignore` file).
    * Paths should always use POSIX-style forward slashes (`/`) as is standard for `.gitignore` files.

5.  **User Feedback**:
    * When `.gitignore` is modified by Ruler, a console message should indicate this (e.g., `[ruler] Updated .gitignore with X unique path(s) in the Ruler block.`).
    * If the feature is disabled, or if no changes were necessary to the Ruler-managed entries in `.gitignore`, no specific message about `.gitignore` is required beyond the standard completion message for the `apply` command.

### Out of Scope for Initial Implementation (Potentially Future Enhancements):

* Removing entries from the Ruler-managed `.gitignore` block if an agent's output path changes to something outside of Ruler's control or an agent is completely removed from Ruler's management.
* Detecting and removing paths from `.gitignore` that were added by Ruler if the feature is later disabled globally.

## 2. Development Workflow and Detailed Step-by-Step Implementation Plan

This feature must be developed using a **Test-Driven Development (TDD)** approach. For each functional unit or step outlined below, the implementer will first write comprehensive tests. Only after the tests are written and failing as expected should the implementation code be developed to satisfy these tests.

### General Development Process:

1.  **Create Branch**: Start by creating a new feature branch from the `main` branch (e.g., `feature/gitignore-integration`).
2.  **Write Tests**: For each component of the functionality, define and write thorough unit and/or end-to-end (E2E) tests. These tests should cover success scenarios, edge cases (e.g., missing files, empty files, various existing `.gitignore` content), and configuration precedence.
3.  **Implement**: Write the minimum amount of code necessary to make the newly written tests pass. Focus on fulfilling the test requirements directly.
4.  **Refactor**: Once tests are passing, refactor the code for clarity, efficiency, and adherence to existing coding conventions within the project. Ensure tests continue to pass after refactoring.
5.  **Lint and Format**: Regularly run `npm run lint` and `npm run format` throughout the development process. All linting and formatting issues must be resolved.
6.  **Local Validation**: Before committing, ensure all tests (`npm test`) pass locally.
7.  **Commit**: Make small, atomic commits with clear and descriptive messages that explain the purpose of the changes.
8.  **Push Branch**: Push the feature branch to the remote repository.
9.  **Create Pull Request (PR)**: Open a Pull Request (PR) on GitHub, targeting the `main` branch. Provide a clear description of the changes, the functionality added, and how it has been tested.
10. **CI Validation and Iteration**:
    * The CI pipeline (GitHub Actions) will automatically run on the PR.
    * Use the GitHub CLI (`gh`) or the GitHub web interface to monitor CI progress (e.g., `gh pr checks <PR_NUMBER_OR_BRANCH_NAME>`, `gh run watch <RUN_ID>`).
    * If CI fails, analyze the errors reported. Fix the issues locally, ensuring all local checks (lint, format, test) pass. Commit and push the fixes to the feature branch.
    * This cycle of fixing, testing locally, pushing, and CI validation must be repeated until all local tests pass and the CI pipeline on GitHub Actions is green.
11. **Address Review Feedback**: The PR will be reviewed. Address any feedback or requested changes by repeating steps 2-7 and 10 as necessary.

---

### Step 1: Update Configuration Loading (TDD)

* **Target Files**: Primarily `src/core/ConfigLoader.ts` and its corresponding test file `tests/unit/core/ConfigLoader.test.ts`.
* **Testing Instructions**:
    * Define test cases in `ConfigLoader.test.ts` to verify that `loadConfig` correctly parses the new `[gitignore]` section from a `ruler.toml` file.
    * Cover scenarios such as: `enabled = true`, `enabled = false`, the `[gitignore]` section being present but the `enabled` key missing, and the entire `[gitignore]` section being absent from the TOML file.
    * Ensure tests confirm that the absence of the section or key results in a configuration state that allows the default behaviour (enabled) to apply correctly later in the logic.
* **Implementation Instructions**:
    * Define the necessary interface(s) for gitignore configuration (e.g., `GitignoreConfig`) and update the `LoadedConfig` interface in `src/core/ConfigLoader.ts` to include this new configuration type.
    * Modify the `loadConfig` function to look for and parse the `[gitignore]` TOML section. It should populate the new gitignore-related property on the `LoadedConfig` object.

---

### Step 2: Update CLI Commands (TDD)

* **Target Files**: `src/cli/commands.ts`. E2E tests in `tests/e2e/` will be the primary way to verify this.
* **Testing Instructions (E2E)**:
    * Write or augment E2E tests to confirm that the `apply` command correctly interprets the new `--gitignore` and `--no-gitignore` flags.
    * Test that providing `--no-gitignore` results in the core logic receiving a clear "disable" signal for the gitignore feature for that run.
    * Test that providing `--gitignore` results in a clear "enable" signal.
    * Test that if neither flag is provided, the core logic receives a signal indicating that the CLI did not explicitly set this option, allowing TOML or default configurations to take effect.
* **Implementation Instructions**:
    * In `src/cli/commands.ts`, add the `--gitignore` and `--no-gitignore` options to the `yargs` configuration for the `apply` command.
    * Ensure the argument parsing logic correctly identifies whether either of these flags was explicitly used.
    * Modify the `apply` command's handler function to pass this CLI-derived gitignore preference (explicitly true, explicitly false, or "not set by CLI") to the `applyAllAgentConfigs` function in `src/lib.ts`.

---

### Step 3: Implement Core `.gitignore` Update Logic (TDD)

* **Target Files**: `src/lib.ts` for the main orchestration; a new utility module (e.g., `src/core/GitignoreUtils.ts`) or extend `src/core/FileSystemUtils.ts` for the direct `.gitignore` file manipulation. Test files will include a new unit test file (e.g., `tests/unit/core/GitignoreUtils.test.ts`) and updates to E2E tests.
* **Testing Instructions (Unit Tests for `.gitignore` manipulation)**:
    * In a new test file (e.g., `GitignoreUtils.test.ts`), create comprehensive tests for the function that will handle reading, modifying, and writing the `.gitignore` file.
    * Scenarios to test include: `.gitignore` not existing (should be created with Ruler block); `.gitignore` being empty; `.gitignore` having pre-existing unrelated content; `.gitignore` having a pre-existing Ruler-managed block (test additions, idempotency, sorting); all specified paths already existing in `.gitignore` (some in the block, some outside); correct handling of POSIX paths; and robust error handling (e.g., for file permission issues, mocked via `fs` module).
* **Testing Instructions (E2E for `applyAllAgentConfigs`)**:
    * Update or add E2E tests to cover the end-to-end behaviour.
    * Verify correct `.gitignore` updates based on the full precedence: CLI > TOML > Default.
    * Ensure all generated file paths, including those from agents with multiple outputs (like Aider) and custom paths specified in `ruler.toml`, are correctly identified and added to `.gitignore` when the feature is active.
    * Confirm that `.bak` files are not added.
* **Implementation Instructions (`GitignoreUtils.ts` or `FileSystemUtils.ts`)**:
    * Develop the function responsible for reading the project's `.gitignore` file.
    * Implement logic to parse existing entries and identify the Ruler-managed block (if any).
    * Add new, unique, project-relative, POSIX-style paths to the Ruler block, ensuring alphabetical sorting.
    * Write the updated content back to `.gitignore`, creating the file if it doesn't exist.
    * Implement the header and footer for the Ruler-managed block.
* **Implementation Instructions (`src/lib.ts` - `applyAllAgentConfigs`)**:
    * Modify `applyAllAgentConfigs` to accept the CLI-derived gitignore preference.
    * Initialize a data structure (e.g., a `Set`) to collect all unique, project-relative paths of files generated by the selected agents. Consider custom output paths from `agentConfig` as overrides to default paths.
    * Implement the configuration precedence logic (CLI > TOML > Default) to determine the final decision on whether to update `.gitignore`.
    * If the decision is to update, and there are paths to add, call the `.gitignore` manipulation function.
    * Log appropriate messages to the console.

---

### Step 4: Update Documentation ("Documentation as Code" Approach)

* **Target File**: `README.md`.
* **Process**:
    * Treat documentation updates as integral to the development process.
    * After implementing the CLI and TOML configuration changes, update `README.md` to accurately reflect these new options.
    * Describe the `--[no-]gitignore` CLI flags for the `apply` command, including their behaviour and precedence.
    * Detail the new `[gitignore]` section and its `enabled` key for `ruler.toml` configuration.
    * Ensure examples are clear and correct.
    * Review the updated documentation for clarity and completeness as if you were a new user.

---

### Step 5: Update Project Versioning and Changelog

* **Target Files**: `package.json`, `CHANGELOG.md`.
* **Implementation Instructions**:
    * Increment the `version` in `package.json` according to the project's semantic versioning guidelines (e.g., to `0.2.0` or `0.3.0`, aligning with other features in the release). The current `CHANGELOG.md` suggests `0.2.0` is for MCP; this new feature might warrant `0.3.0` or be included if `0.2.0` is not yet released.
    * Add a clear and concise entry to `CHANGELOG.md` under the "Added" subsection for the new version, describing the `.gitignore` update functionality and how it can be controlled.

---

By following this TDD approach and the detailed workflow, the implementer will produce a high-quality, well-tested feature that integrates smoothly into the existing Ruler CLI tool.